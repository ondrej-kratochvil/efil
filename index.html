<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Management Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        :root { --touch-target: 48px; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; font-size: 16px; -webkit-tap-highlight-color: transparent; }
        .touch-target { min-width: var(--touch-target); min-height: var(--touch-target); }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); gap: 12px; }
        #action-menu { transition: transform 0.2s ease-out, opacity 0.2s ease-out; }
        #action-menu.hidden { transform: translateY(-10px); opacity: 0; pointer-events: none; display: block !important; }
        input, select { font-size: 16px !important; }
        .field-container { display: flex; flex-direction: column; gap: 4px; }
        .input-group { display: flex; gap: 8px; }
    </style>
</head>
<body class="text-slate-900">

    <!-- Header & Navigation -->
    <header class="sticky top-0 z-50 bg-white border-b border-slate-200 shadow-sm">
        <div class="max-w-5xl mx-auto flex items-center justify-between px-4 h-16">
            <div onclick="resetApp()" class="cursor-pointer text-indigo-600 flex items-center">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            </div>

            <nav id="wizard-nav" class="flex h-full">
                <button onclick="setStep(1)" id="nav-mat" class="flex flex-col items-center justify-center px-3 h-full text-xs font-medium border-b-2 transition-all uppercase tracking-wider">
                    <span class="text-[13px]">MAT</span>
                </button>
                <button onclick="setStep(2)" id="nav-bar" class="flex flex-col items-center justify-center px-3 h-full text-xs font-medium border-b-2 transition-all uppercase tracking-wider">
                    <span class="text-[13px]">BAR</span>
                </button>
                <button onclick="setStep(3)" id="nav-vyr" class="flex flex-col items-center justify-center px-3 h-full text-xs font-medium border-b-2 transition-all uppercase tracking-wider">
                    <span class="text-[13px]">VÝR</span>
                </button>
            </nav>
            
            <div id="form-title" class="hidden font-bold text-slate-500 uppercase tracking-widest text-sm">Editor</div>

            <div class="flex items-center gap-2">
                <div id="sync-status" class="w-2 h-2 rounded-full bg-slate-200" title="Stav synchronizace"></div>
                <button onclick="toggleActionMenu()" id="menu-trigger" class="touch-target w-10 h-10 flex items-center justify-center text-slate-600 hover:bg-slate-100 rounded-full transition-colors">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                </button>
            </div>
        </div>

        <div id="action-menu" class="absolute left-0 right-0 bg-white border-b border-slate-200 shadow-xl z-40 hidden overflow-hidden">
            <div class="max-w-5xl mx-auto p-4 space-y-2">
                <button onclick="openForm()" class="w-full flex items-center gap-4 p-4 hover:bg-slate-50 rounded-xl font-bold touch-target text-left">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg></div>
                    Přidat nový filament
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 pb-24">
        <div id="loading-screen" class="py-20 text-center">
            <div class="inline-block w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-slate-400 font-medium">Připojování ke cloudu...</p>
        </div>
        <div id="app-view" class="hidden"></div>
    </main>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl opacity-0 transition-opacity pointer-events-none z-[60]">Uloženo</div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURACE ---
        
        // ID aplikace pro Firestore (v Canvas se plní automaticky)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'filament-tracker-dev';

        /**
         * POKUD SPOUŠTÍTE LOKÁLNĚ: 
         * Musíte zde vyplnit objekt 'firebaseConfig' údaji ze svého Firebase projektu (Console -> Project Settings).
         * Pokud ho necháte prázdný, aplikace se v lokálním prohlížeči nespustí.
         */
        const localFirebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : localFirebaseConfig;

        // Inicializace Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let filaments = [];
        let user = null;
        let state = {
            view: 'wizard',
            currentStep: 1,
            filters: { mat: null, color: null },
            editingId: null,
            formFieldsStatus: { mat: 'select', man: 'select', loc: 'select', seller: 'select' }
        };

        const colorNames = [
            { name: 'Černá', hex: '#000000' }, { name: 'Bílá', hex: '#ffffff' }, { name: 'Červená', hex: '#ff0000' },
            { name: 'Zelená', hex: '#00ff00' }, { name: 'Modrá', hex: '#0000ff' }, { name: 'Žlutá', hex: '#ffff00' },
            { name: 'Oranžová', hex: '#ffa500' }, { name: 'Šedá', hex: '#808080' }, { name: 'Stříbrná', hex: '#c0c0c0' },
            { name: 'Zlatá', hex: '#ffd700' }, { name: 'Fialová', hex: '#800080' }, { name: 'Hnědá', hex: '#a52a2a' }
        ];

        // --- AUTH & DATA SYNC ---

        const initAuth = async () => {
            if (!firebaseConfig.apiKey) {
                document.getElementById('loading-screen').innerHTML = `
                    <p class="text-red-500 font-bold">Chyba: Chybí konfigurace Firebase.</p>
                    <p class="text-sm text-slate-500 mt-2 px-4">Otevřete kód a vyplňte <code>localFirebaseConfig</code> údaji ze své konzole Firebase.</p>
                `;
                return;
            }

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth failed", err);
                showToast("Chyba připojení");
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('sync-status').classList.replace('bg-slate-200', 'bg-green-500');
                subscribeToData();
            }
        });

        const subscribeToData = () => {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'filaments');
            onSnapshot(colRef, (snapshot) => {
                filaments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                render();
            }, (err) => {
                console.error("Firestore error", err);
                showToast("Chyba čtení dat");
            });
        };

        // --- UI LOGIC ---

        function getClosestColorName(hex) {
            function hexToRgb(h) {
                let r = parseInt(h.slice(1, 3), 16), g = parseInt(h.slice(3, 5), 16), b = parseInt(h.slice(5, 7), 16);
                return [r, g, b];
            }
            const target = hexToRgb(hex);
            let minDist = Infinity;
            let closest = 'Vlastní barva';
            colorNames.forEach(c => {
                const curr = hexToRgb(c.hex);
                const dist = Math.sqrt(Math.pow(target[0]-curr[0],2) + Math.pow(target[1]-curr[1],2) + Math.pow(target[2]-curr[2],2));
                if (dist < minDist) { minDist = dist; closest = c.name; }
            });
            return minDist < 60 ? closest : 'Vlastní barva';
        }

        window.render = () => {
            const appView = document.getElementById('app-view');
            updateHeader();
            appView.innerHTML = '';
            if (state.view === 'form') renderForm(appView);
            else {
                if (state.currentStep === 1) renderMaterials(appView);
                else if (state.currentStep === 2) renderColors(appView);
                else if (state.currentStep === 3) renderDetails(appView);
            }
        };

        const updateHeader = () => {
            const nav = document.getElementById('wizard-nav'), fTitle = document.getElementById('form-title');
            if (state.view === 'form') { nav.classList.add('hidden'); fTitle.classList.remove('hidden'); }
            else {
                nav.classList.remove('hidden'); fTitle.classList.add('hidden');
                ['nav-mat', 'nav-bar', 'nav-vyr'].forEach((id, idx) => {
                    const el = document.getElementById(id), active = state.currentStep === (idx + 1);
                    el.className = `flex flex-col items-center justify-center px-3 h-full text-xs font-medium border-b-2 transition-all uppercase tracking-wider ${active ? 'border-indigo-600 text-indigo-600 font-bold' : 'border-transparent text-slate-400'}`;
                });
                document.getElementById('nav-mat').querySelector('span').innerText = state.filters.mat || 'MAT';
                document.getElementById('nav-bar').querySelector('span').innerText = state.filters.color || 'BAR';
            }
        };

        const formatKg = (g) => (g / 1000).toFixed(1).replace('.', ',') + ' kg';
        const getContrast = (hex) => {
            const r = parseInt(hex.substring(1,3),16), g = parseInt(hex.substring(3,5),16), b = parseInt(hex.substring(5,7),16);
            return (((r*299)+(g*587)+(b*114))/1000) >= 128 ? '#000000' : '#ffffff';
        };

        const renderMaterials = (v) => {
            const grid = document.createElement('div'); grid.className = "card-grid";
            const data = state.filters.color ? filaments.filter(i => i.color === state.filters.color) : filaments;
            const stats = data.reduce((acc, i) => { acc[i.mat] = (acc[i.mat] || 0) + (parseInt(i.g) || 0); return acc; }, {});
            Object.keys(stats).sort((a,b)=>stats[b]-stats[a]).forEach(m => {
                const card = document.createElement('div');
                card.className = "aspect-square bg-white border border-slate-200 rounded-2xl p-3 flex items-center justify-center text-center relative shadow-sm cursor-pointer";
                card.onclick = () => { state.filters.mat = m; state.currentStep = state.filters.color ? 3 : 2; window.render(); };
                card.innerHTML = `<div class="text-[10px] font-bold text-slate-400 absolute top-2 right-2">${formatKg(stats[m])}</div><div class="text-base font-black uppercase tracking-tight">${m}</div>`;
                grid.appendChild(card);
            });
            v.appendChild(grid);
        };

        const renderColors = (v) => {
            const grid = document.createElement('div'); grid.className = "card-grid";
            const data = state.filters.mat ? filaments.filter(i => i.mat === state.filters.mat) : filaments;
            const stats = data.reduce((acc, i) => { if(!acc[i.color]) acc[i.color]={g:0, hex:i.hex}; acc[i.color].g+=(parseInt(i.g)||0); return acc; }, {});
            Object.keys(stats).sort((a,b)=>stats[b].g-stats[a].g).forEach(c => {
                const info = stats[c], contrast = getContrast(info.hex), card = document.createElement('div');
                card.className = "aspect-square rounded-2xl p-3 flex items-center justify-center text-center shadow-sm relative cursor-pointer";
                card.style.backgroundColor = info.hex; card.style.color = contrast;
                if(info.hex.toLowerCase()==='#ffffff') card.classList.add('border','border-slate-200');
                card.onclick = () => { state.filters.color = c; state.currentStep = state.filters.mat ? 3 : 1; window.render(); };
                card.innerHTML = `<div class="text-[10px] font-bold absolute top-2 right-2 opacity-70">${formatKg(info.g)}</div><div class="text-[13px] font-black uppercase px-1">${c}</div>`;
                grid.appendChild(card);
            });
            v.appendChild(grid);
        };

        const renderDetails = (v) => {
            const container = document.createElement('div'); container.className = "flex flex-col gap-3 w-full";
            const filtered = filaments.filter(i => (!state.filters.mat || i.mat===state.filters.mat) && (!state.filters.color || i.color===state.filters.color)).sort((a,b)=>b.g-a.g);
            if(filtered.length === 0) container.innerHTML = `<div class="text-center py-20 text-slate-400 bg-white rounded-3xl border-2 border-dashed">Žádné položky</div>`;
            else filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-2xl border border-slate-200 flex items-center justify-between shadow-sm cursor-pointer";
                card.onclick = () => window.openForm(item.id);
                card.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full border border-slate-100 shadow-inner" style="background-color: ${item.hex}"></div>
                        <div>
                            <div class="font-bold text-slate-900 flex items-center gap-2">${item.man} <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-slate-300"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 1 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div>
                            <div class="text-xs text-slate-500 font-medium uppercase mt-0.5">${item.mat} • ${item.color}</div>
                            <div class="text-[10px] text-indigo-500 font-bold mt-1 uppercase">#${item.id.slice(-4)} • ${item.loc || '?'}</div>
                            ${item.price ? `<div class="text-[9px] text-slate-400 mt-1 font-medium">${item.price} Kč • ${item.seller || '?'}</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black text-indigo-600 leading-none">${item.g}<span class="text-xs ml-0.5">g</span></div>
                        <div class="text-[9px] text-slate-400 font-bold mt-1 uppercase">Zůstatek</div>
                    </div>
                `;
                container.appendChild(card);
            });
            v.appendChild(container);
            const btn = document.createElement('button'); btn.className = "mt-6 w-full py-4 text-indigo-600 font-bold text-sm bg-indigo-50 rounded-2xl";
            btn.innerText = "Vymazat filtry"; btn.onclick = window.resetApp; v.appendChild(btn);
        };

        const renderForm = (v) => {
            const item = state.editingId ? filaments.find(i => i.id === state.editingId) : { mat: '', color: '', hex: '#4f46e5', man: '', g: 1000, loc: '', price: '', date: '', seller: '' };
            const mats = [...new Set(filaments.map(x => x.mat))].sort();
            const mans = [...new Set(filaments.map(x => x.man))].sort();
            const locs = [...new Set(filaments.map(x => x.loc).filter(Boolean))].sort();
            const sellers = [...new Set(filaments.map(x => x.seller).filter(Boolean))].sort();

            const form = document.createElement('div');
            form.className = "bg-white p-6 rounded-3xl shadow-sm border border-slate-200 max-w-lg mx-auto space-y-5";
            form.innerHTML = `
                <div class="field-container">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase">Barva (Paleta a Název)</label>
                    <div class="flex gap-2">
                        <input id="f-hex" type="color" value="${item.hex}" oninput="window.handleColorChange(this.value)" class="w-16 h-12 bg-transparent border-none p-0 cursor-pointer">
                        <input id="f-color" type="text" value="${item.color}" placeholder="Název" class="flex-1 bg-slate-50 border-none rounded-xl p-3 font-bold">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="field-container"><label class="text-[10px] font-bold text-slate-400 uppercase">Materiál</label><div class="input-group">${renderFieldInput('mat', mats, item.mat)}</div></div>
                    <div class="field-container"><label class="text-[10px] font-bold text-slate-400 uppercase">Výrobce</label><div class="input-group">${renderFieldInput('man', mans, item.man)}</div></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="field-container"><label class="text-[10px] font-bold text-slate-400 uppercase">Hmotnost (g)</label><input id="f-g" type="number" value="${item.g}" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold"></div>
                    <div class="field-container"><label class="text-[10px] font-bold text-slate-400 uppercase">Umístění</label><div class="input-group">${renderFieldInput('loc', locs, item.loc)}</div></div>
                </div>
                
                <div class="border-t border-slate-100 pt-4 space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase">Obchodní údaje</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="field-container">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Cena (Kč)</label>
                            <input id="f-price" type="number" value="${item.price || ''}" class="w-full bg-slate-50 border-none rounded-xl p-3 font-bold">
                        </div>
                        <div class="field-container">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Datum pořízení</label>
                            <input id="f-date" type="date" value="${item.date || ''}" class="w-full bg-sla
